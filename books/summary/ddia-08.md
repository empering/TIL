# 데이터 중심 애플리케이션 설계

> 마틴 클레프만 저 | 정재부 , 김영준 , 이도경 역 | 위키북스 | 2018.

​	

![book-cover](https://user-images.githubusercontent.com/13076271/88173485-9b6f2a00-cc5d-11ea-8284-72ffb0f33174.jpg)

[책 구매하기](https://coupa.ng/bGCnLK)

>  위 링크를 통해 제품 구매가 이루어진 경우 쿠팡 파트너스 활동 일환으로 인해 일정 수수료가 블로거에게 제공됨.



***<u>본 내용은 책 내용에 대한 개인적 이해를 바탕으로 한 요약과 생각이므로 정확한 내용은 반드시 책을 참고하길 권장함.</u>***





# 8장. 분산 시스템의 골칫거리

분산 시스템에서는 다음과 같은 문제들이 존재.

- 공유 메모리가 없음
- 지연 변동이 큰 신뢰할 수 없는 네트워크를 통해 메시지를 보냄
- 부분 장애
- 신뢰성 없는 시계
- 프로세스 중단

엔지니어로서 우리의 임무는 비관주의를 최대한 끌어올려 어떤 것이든 잘못될 가능성이 있다면 잘못된다고 가정, 모든 게 잘못되더라도 제 역할을 해내는 시스템을 구축하는 것.

## 결함과 부분 장애

- 한 컴퓨터에서 프로그램을 작성할 때는 프로그램이 보통 상당히 예측 가능한 방식으로 동작.
- 또한, 보통 시스템이 완전하게 동작하거나 전체 장애가 발생하지 그 중간 상태는 되지 않음.
- 분산 시스템에서 시스템의 어떤 부분은 잘 동작하지만 다른 부분은 예측할 수 없는 방식으로 고장 나는 것은 무리가 아님.

분산 시스템이 동작하게 만들려면 신뢰성 없는 구성 요소를 사용해 신뢰성 있는 시스템을 구축해야 함. 예컨대 해밍코드, TCP 같은 것들이 신뢰성이 낮은 기반을 사용해 신뢰성이 더 높은 시스템을 구축한 것. 

의심, 비관주의, 편집증은 분산 시스템에서 그 값어치를 함.

## 신뢰성 없는 네트워크

네트워크에서 노드는 다른 노드로 패킷을 보낼 수 있지만 언제 도착할지 혹은 도착할것인가에 대한 것은 보장하지 못함.

요청을 보내고 응답을 기다릴 때 여러가지가 잘못될 수 있음.

- 요청 자체의 손실
- 요청이 큐에서 대기하다 지연 전송
- 원격 노드에 장애 발생
- 원격 노드가 일시적으로 응답을 멈췄지만 나중에 다시 응답 시작
- 원격 노드가 요청을 처리했지만 응답이 네트워크에서 손실
- 원격 노드가 요청을 처리했지만 응답이 지연되다가 나중에 전송

이런 문제를 다루는 흔한 방법은 타임아웃. 그러나 타임아웃이 발생했을 때 원격 노드가 응답을 받았는지 아닌지는 여전히 알 수 없음.

반면, 네트워크 결함을 반드시 견뎌낼 필요는 없음. 네트워크가 평상시에 상당히 믿을 만하다면 그냥 사용자에게 오류 메세지를 보여주는 비용이 훨씬 저렴할 것.그러나 소프트웨어가 네트워크 문제에 어떻게 반응하는지 알고 시스템이 그로부터 복구할 수 있도록 보장해야 함. 그러기 위해서는 결함을 감지해야 함.

### 결함 감지

- 로드 밸런서는 죽은 노드로 요청을 그만 보내야 함
- 단일 리더 복제를 사용하는 분산 데이터베이스에서 리더에 장애가 나면 팔로워 중 하나가 리더로 승격돼야 함

하지만 불행히 네트워크에 관한 불확실성 때문에 구분이 어려움.

타임아웃을 사용해 시간 내 응답을 받지 못하면 노드가 죽었다고 선언할 수도 있음. 하지만 다음과 같은 문제도 고려해야 함.

- 타임아웃이 길면 노드가 죽었다고 선언될 때 까지 시간이 길어짐
- 타임아웃이 짧으면 결함을 빨리 발견하지만 노드의 일시적인 결함에 죽었다고 잘못 선언할 위험이 높아짐
- 성급하게 노드가 죽었다고 선언하면 노드가 실제로는 살아 있고 어떤 동작을 실행하는 중일 때 다른 노드가 역할을 넘겨 받으면 그 동작을 두 번 실행할지 모름

### 네트워크 혼잡과 큐 대기

네트워크 패킷 지연의 변동성은 큐 대기 때문인 경우가 많음.

출발지에서 목적지까지 가능 동안 다양한 큐에 머무름. 게다가 TCP 는 어떤 타임아웃 안에 확인 응답을 받지 않으면 패킷이 손실됐다고 간주하기 때문에 재전송으로 인해 생기는 지연도 발생할 수 있음.

- 지연의 변동성이 얼마나 되는지 알아내려면 긴 기간에 여러 장비에 걸쳐 네트워크 왕복 시간 분포를 측정해야 함.
- 그 후 애플리케이션 특성을 고려해 장애 감지 지연과 너무 이른 타임아웃의 위험성 사이 적절한 트레이드 오프 선택
- 더 좋은 방법은 고정된 타임아웃을 설정하는 대신 시스템이 지속적으로 응답 시간과 그들의 변동성을 측정하고 관찰된 응답 시간 분포에 따라 타임아웃을 자동으로 감지하는 것

## 신뢰성 없는 시계

분산 시스템에서 개별 장비는 자신의 시계를 갖고 있고 특히 변동이 큰 신뢰할 수 없는 네트워크와 결합 됐을 때 여러가지 문제를 유발할 수 있음.

## 지식, 진실, 그리고 거짓말

TODO 신뢰성 없는 시계와 지식, 진실, 그리고 거짓말 장은 왠지 잘 안읽힘. 나중에 다시 읽기.
