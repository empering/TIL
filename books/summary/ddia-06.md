# 데이터 중심 애플리케이션 설계

> 마틴 클레프만 저 | 정재부 , 김영준 , 이도경 역 | 위키북스 | 2018.


![book-cover](https://user-images.githubusercontent.com/13076271/88173485-9b6f2a00-cc5d-11ea-8284-72ffb0f33174.jpg)

[책 구매하기](https://coupa.ng/bGCnLK)

>  위 링크를 통해 제품 구매가 이루어진 경우 쿠팡 파트너스 활동 일환으로 인해 일정 수수료가 블로거에게 제공됨.



***<u>본 내용은 책 내용에 대한 개인적 이해를 바탕으로 한 요약과 생각이므로 정확한 내용은 반드시 책을 참고하길 권장함.</u>***




# 6장. 파티셔닝

파티셔닝의 목적은 데이터와 질의 부하를 노드 사이에 고르게 분산시키는 것. 각 파티션은 그 자체로 작은 데이터베이스가 된다고 볼 수 있음.

하지만 파티셔닝이 고르게 이뤄지지 않아 데이터가 더 많거나 질의를 많이 받는 상황을 쏠렸다(skewed)고 하고, 불균형하게 부하가 높은 파티션을 핫스팟이라고 함.

이 장에서는 이를 극복하기 위한 방법들을 주로 설명

## 키-값 데이터 파티셔닝

- 핫스팟을 회피하는 가장 단순한 방법은 레코드를 할당할 노드를 무작위 선택하는 것
- 데이터가 노드들 사이에 매우 고르게 분산되는 반면, 특정 레코드를 읽을때 어느 노드에 있는지 알 수 없음. 따라서 모든 노드에 병렬 질의 해야 함.
- 키-값 데이터 모델에서는 항상 기본키를 통해 접근함으로써 이를 해결 가능

### 키 범위 기준 파티셔닝

- 종이 백과사전처럼 각 파티션에 연속된 범위의 키를 할당하는 것. 예컨대 노드1에는 A~B 까지.
- 각 범위들 사이의 경계를 알면 어떤 키가 어느 파티션에 속하는지 쉽게 찾음.
- 키 범위 크기는 반드시 동일할 필요 X. 데이터가 고르게 분포하지 않을 수 있기 때문.
- 이 방법의 문제는 특정한 접근 패턴이 핫스팟을 유발한다는 것. 예를 들어 타임스탬프가 키이고 이를 기준으로 파티셔닝한다면 오늘 발생하는 쓰기는 모든 같은 파티션으로 쏠림.

### 키의 해시값 기준 파티셔닝

- 쏠림과 핫스팟의 위험으로 많은 분산 데이터 스토어는 키의 파티션을 정하는데 해시 함수를 사용
- 반면 해시값을 사용하면 키 범위 파티셔닝의 좋은 속성을 잃게 됨. 바로 범위 질의를 효과적으로 실행할 수 있는 능력.
- 키 범위 기준 파티셔닝은 인접 키들이 같은 파티션에 속하지만 해시값으로 파티셔닝시 모든 파티션에 흩어져 정렬 순서가 유지되지 않고 모든 파티션에 질의가 전송되어야 함.

### 쏠린 작업부하와 핫스팟 완화

- 해시값 기준 파티셔닝으로도 핫스팍을 완벽히 제거할 수는 없음. 항상 동일한 키를 읽고 쓰는 극단적인 상황에서는 모든 요청이 동일 파티션에 쏠림.
- 예컨대 소셜 미디어 사이트에서 수백만 팔로워를 거느린 유명인이 실행한 어떤 작업으로 동일한 키에 막대한 데이터를 기록해야 한다거나
- 현대 데이터 시스템은 대부분 크게 쏠린 작업부하를 자등으로 보정하지 못하므로 애플리케이션에서 쏠림을 완화해야 함.
- 가장 간단한 방법은 요청이 매우 쏠리는 키를 발견했을 때 작업키 시작이나 끝에 임의의 숫자를 붙이는 것. 임의의 10진수 두개만 붙여도 한 키에 대한 쓰기 작업이 100개의 다른 키로 균등하게 분산.
- 트레이드 오프는 해당 임의의 숫자를 어딘가에 기억해야 한다는 것이고, 해시값 기준 파티셔닝의 단점과 같이 읽기시 추가적인 작업이 필요하다는 것.


## 파티셔닝과 보조 색인

- 보조 색인은 보통 레코드를 유일하게 식별하는 용도가 아니라 특정한 값이 발생한 항목을 검색하는 수단
- 예컨대 사용자 A가 실행한 액션을 모두 찾거나, hogwash 라는 포함하는 글을 모두 찾거나, 빨간색 자동차를 모두 찾는 등. 이를 위해 솔라나 엘라스틱서치 같은 검색 서버가 존재함
- 보조 색인은 파티션에 깔끔하게 대응되지 않음. 보조 색인이 있는 데이터베이스를 파티셔닝하는데 널리 쓰이는 두가지 방법을 소개함

### 문서 기준 보조 색인 파티셔닝

- (전역 색인과 반대인) 지역 색인이라고도 함
- 데이터베이스는 문서 ID 기준으로 파티셔닝하고 각 파티션이 자신의 보조 색인을 유지하며 해당 파티션의 문서만 담당
- 예컨대 color:red 라는 보조 색인이 파티션 0, 1, 2.. 에도 존재하고 각 파티션별 색인은 해당 파티션의 문서번호만 알고 있음
- 이 경우 스캐터/개더 방식으로 모든 파티션에 질의를 보낸 후 결과를 모아야 함

### 용어 기반 파티셔닝

- 문서 기준 색인과 반대로 모든 파티션의 데이터를 담당하는 전역 색인
- 모든 파티션에 있는 coler:red 의 문서번호가 한 파티션의 보조 색인에 저장됨
- 색인을 할 때 용어 자체를 사용 쓸 수도, 용어의 해시값을 사용할 수도 있음. 트레이드 오프는 앞서 키-값 데이터 파티셔닝에서 언급한 것과 같음.

## 파티션 재균형화

시간이 지나면서 데이터베이스는 변화가 생김

- 질의 처리량이 증가해서 늘어난 부하 처리를 위해 CPU 를 추가하고 싶음
- 데이터셋 크기가 증가해서 데이터셋 저장에 사용할 디스크와 램을 추가하고 싶음
- 장비에 장애가 발생해서 그 장비가 담당하던 역할을 다른 장비가 넘겨받아야 함

이런 변화가 생기면 데이터와 요청이 한 노드에서 다른 노드로 옮겨져야 함. 이를 재균형화(rebalancing)라고 함. 재균형화가 실행될 때 보통 만족시킬 것으로 기대되는 최소 요구사항은 다음과 같음.

- 재균형화 후, 부하가 클러스터 내에 있는 노드 사이에 균등하게 분배
- 재균형화 도중 데이터베이스는 읽기, 쓰기 요청을 받아들여야 함
- 재균형화가 빨리 실행되고 네트웍과 디스크 I/O 부하를 최소화하도록 노드 사이에 데이터가 필요 이상으로 옮겨져서는 안됨

이 장에서는 몇가지 재균형화 전략을 소개함

- 해시값에 모드 N 연산 실행 (쓰면 안 되는 방법)
- 파티션 개수 고정
- 동적 파티셔닝
- 노드 비례 파티셔닝

## 요청 라우팅

- 파티션이 재균형화 되면 노드에 할당된 파티션이 바뀜. foo 키를 읽으려면 어떤 IP 와 어떤 포트로 접속해야 하나?
- 데이터베이스에 국한되지 않는 더욱 일반적인 문제인 서비스 찾기(discovery)의 일종
- 분산시스템에서 이런 클러스터 메타데이터를 추적하기 위한 코디네이션 서비스가 주키퍼 같은 것들임
